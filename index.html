<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Opengis</title>
    
    <!--************************CSS files********************-->
    <link rel="stylesheet" href="src/leaflet.css">
    <link rel="stylesheet" href="src/bootstrap.css">
   
 
    <link rel="stylesheet" href="plugins/easy-button.css">
    <link rel="stylesheet" href="plugins/MarkerCluster.css">
    <link rel="stylesheet" href="plugins/MarkerCluster.Default.css">
    <link rel="stylesheet" href="plugins/L.Control.OpenCageSearch.css">
    <link rel="stylesheet" href="plugins/Leaflet.PolylineMeasure.css">
     <!--************************font awesome cdn********************-->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">


    
    <link rel="stylesheet" href="src/plugins/sidebar-v2-master/css/leaflet-sidebar.css">
    
    <!--********************JS librarys**********************-->
    <script src="src/leaflet.js"></script>
    <script src="plugins/leaflet-providers.js"></script>
    <script src="src/jquery-3.2.0.js"></script>
    <script src="src/bootstrap.js"></script>
    <!--<script src="plugins/L.Control.Sidebar.js"></script>-->
    <script src="plugins/easy-button.js"></script>
    <script src="plugins/leaflet.markercluster.js"></script>
    <script src="plugins/L.Control.OpenCageSearch.js"></script>
     <script src="plugins/bundle.js"></script>
    <script src="plugins/Leaflet.PolylineMeasure.js"></script>
    <script src="plugins/Leaflet.PolylineMeasure.js"></script>
    <script src="src/plugins/sidebar-v2-master/js/leaflet-sidebar.js"></script>
       
        <!--************************Draw********************-->
        
    <script src="src/plugins/leaflet-draw/src/Leaflet.draw.js"></script>
    <script src="src/plugins/leaflet-draw/src/Leaflet.Draw.Event.js"></script>
    <link rel="stylesheet" href="src/plugins/leaflet-draw/src/leaflet.draw.css"/>

    <script src="src/plugins/leaflet-draw/src/Toolbar.js"></script>
    <script src="src/plugins/leaflet-draw/src/Tooltip.js"></script>

    <script src="src/plugins/leaflet-draw/src/ext/GeometryUtil.js"></script>
    <script src="src/plugins/leaflet-draw/src/ext/LatLngUtil.js"></script>
    <script src="src/plugins/leaflet-draw/src/ext/LineUtil.Intersect.js"></script>
    <script src="src/plugins/leaflet-draw/src/ext/Polygon.Intersect.js"></script>
    <script src="src/plugins/leaflet-draw/src/ext/Polyline.Intersect.js"></script>
    <script src="src/plugins/leaflet-draw/src/ext/TouchEvents.js"></script>
    

    <script src="src/plugins/leaflet-draw/src/draw/DrawToolbar.js"></script>
    <script src="src/plugins/leaflet-draw/src/draw/handler/Draw.Feature.js"></script>
    <script src="src/plugins/leaflet-draw/src/draw/handler/Draw.SimpleShape.js"></script>
    <script src="src/plugins/leaflet-draw/src/draw/handler/Draw.Polyline.js"></script>
    <script src="src/plugins/leaflet-draw/src/draw/handler/Draw.Marker.js"></script>
    <script src="src/plugins/leaflet-draw/src/draw/handler/Draw.Circle.js"></script>
    <script src="src/plugins/leaflet-draw/src/draw/handler/Draw.CircleMarker.js"></script>
    <script src="src/plugins/leaflet-draw/src/draw/handler/Draw.Polygon.js"></script>
    <script src="src/plugins/leaflet-draw/src/draw/handler/Draw.Rectangle.js"></script>


    <script src="src/plugins/leaflet-draw/src/edit/EditToolbar.js"></script>
    <script src="src/plugins/leaflet-draw/src/edit/handler/EditToolbar.Edit.js"></script>
    <script src="src/plugins/leaflet-draw/src/edit/handler/EditToolbar.Delete.js"></script>

    <script src="src/plugins/leaflet-draw/src/Control.Draw.js"></script>

    <script src="src/plugins/leaflet-draw/src/edit/handler/Edit.Poly.js"></script>
    <script src="src/plugins/leaflet-draw/src/edit/handler/Edit.SimpleShape.js"></script>
    <script src="src/plugins/leaflet-draw/src/edit/handler/Edit.Rectangle.js"></script>
    <script src="src/plugins/leaflet-draw/src/edit/handler/Edit.Marker.js"></script>
    <script src="src/plugins/leaflet-draw/src/edit/handler/Edit.CircleMarker.js"></script>
    <script src="src/plugins/leaflet-draw/src/edit/handler/Edit.Circle.js"></script>
        <!--************************End draw********************-->


    

   
  <style>  
    #mapdiv{
            height:100vh;}
      .modal {
          z-index: 2001;
          width: 100%;
          height: 100%;
          display: none;
          background-color: rgba(0,0,0,0.4);
      }
      .modal-content{
          color: black;
          padding: 20px;
          margin-top:5%;
          background-color: white;
          height: 40%;
          overflow-y: auto;
      }
      .tblHeader{
          background-color: white;
      }
      
      .inline{
          display: inline-block;
      }
    </style>    
    
</head>

<body>
     <div id="mapdiv" class="col-md-12"></div> 


     <!-- ***********************Side bar ********************** -->


     <div id="sidebar" class="sidebar collapsed">
        <!-- Side bar side tabls with -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href="#work_area" role="tab"><i class="far fa-square"></i></a></li>
                <li><a href="#add_layers_from_db" role="tab"><i class="fas fa-database" id="dbTab"></i></a></li>
                <li><a href="#active_layers" role="tab"><i class="fas fa-layer-group"></i></a></li>
                <li><a href="#add_data" role="tab"><i class="far fa-plus-square"></i></a></li>
                <li><a href="#edit_mode" role="tab"><i class="fas fa-folder-plus"></i></a></li>
                <li><a href="#addlayer" role="tab"><i class="fas fa-edit"></i></a></li>
                <li><a href="#search" role="tab"><i class="fas fa-search-location"></i></a></li>
                <li><a href="#query_builder" role="tab"><i class="fas fa-filter"></i></i></a></li>
            </ul>

            <ul role="tablist">
                <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    &ltopen&gtGIS
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

              
            </div>

            <div class="sidebar-pane" id="work_area">
               
                <!-- ***********************Set working area********************** -->
                
                <h1 class="sidebar-header">Set working area<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <div>
                   <button class= 'btn btn-default btn-block' id='btn_area'>Manualy set area as polygon</button>
                    <br>
                </div>
                <div>
                   <button class= 'btn btn-default btn-block' id='btn_fullextent'>Full extent</button>
                   <br>
                </div>
                <div>
                   <button class= 'btn btn-default btn-block' id='btn_region'>Set mask by Region</button>
                   <br>
                <div>
                   <button class= 'btn btn-default btn-block' id='btn_kommune'>Set mask as Kommune</button>
                   <br>
                   <div>
                       <form action="/action_page.php">
                          <input list="browsers" id="alertcreate">
                          <datalist id="browsers">
                            <option value="Internet Explorer">
                            <option value="Firefox">
                            <option value="Chrome">
                            <option value="Opera">
                            <option value="Safari">
                          </datalist> 
                        </form>
                   </div>    
                </div>
                </div>
            </div>

            <div class="sidebar-pane" id="add_layers_from_db">
                <h1 class="sidebar-header">Add database layers<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <div>
                   <button class= 'btn btn-default btn-block' id='seeLayers'>See available layers</button>
                   <br>
                </div> 
                  <div id="tableData"></div>
                  
                  
            </div>

            <div class="sidebar-pane" id="active_layers">
                <h1 class="sidebar-header">Active layers<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <div class="active-container" id='activeLayersDiv' >
                    <button> Button 1 </button>
                </div>
            </div>
            <div class="sidebar-pane" id="edit_mode">
               
            </div>
        </div>
    </div>
    
    
    <!-- ***********************Modal dialog box********************** -->
     <div id="dlgModal" class="modal">                                            
         <div id="dlgModal" class="modal-content col-md-auto">
          <span id="buttonCloseModal" class="pull-right"><i class="fa fa-close fa-2x"></i></span>
          <div id="modalData"></div>
      </div>
      
     </div>
      



 
  
  <script>
      $("#butonUnu").on("click",function(){
          $("#unu").toggle();
          $("#unu2").toggle();
      })
      $("#alertcreate").on("input", function(){
          alert('text')
      })
      //************global variables**************
      var baseMaps;
      var overlayMaps;
      var baseLayer_hyda;
      var baseLayer_OpenTopoMap;
      var buttonSideBar;
      
      
      
      var controlSideBar;
      var ctlDraw;
      var controlSearch;
      
      
      var kommune;
      var lyr_kommune;
      var region;
      var lyr_region;
      var layerControl;
     
      var stationer;
      var lyr_stationer;
      
      var lines;
      var lyr_lines;
      
      var lyr_MarkerCluster;
      
      var bbox;
      var lyr_bbox;
      
      var area;
      var res="";
      var coordString="nothing";
      var activeLayersList=[];
       
  //**************map initialisation**********************
      var mymap=L.map('mapdiv',{center:[55.329967,10.983444 ],zoom:10,zoomControl:false});
      
  //var mymap=L.map('mapdiv').setView([55.68,12.55 ],10,{zoom:18,zoomControl:false});
    //L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',).addTo(mymap);
     
//******************Base maps declaration and adding them to the map*************
      baseLayer_hyda=L.tileLayer.provider('Hydda.Full').addTo(mymap);
      baseLayer_OpenTopoMap=L.tileLayer.provider('Esri.WorldImagery').addTo(mymap);
      
      var baseMaps={
          "hyda":baseLayer_hyda,
          "Imagery":baseLayer_OpenTopoMap
      };
    layerControl=L.control.layers(baseMaps).addTo(mymap);
      
    lyr_MarkerCluster=L.markerClusterGroup();
      
   
      var polygonDrawer = new L.Draw.Rectangle(mymap);

    
  // ***************************** Set working Area tab**********************************************   
  //draw area button  
  
 //*************************Sidebar control**************************
    controlSideBar=L.control.sidebar('sidebar').addTo(mymap);
      
//**************************Zoom control*****************************      
    controlZoom=L.control.zoom({position:'topright'}).addTo(mymap);  
      
      
 //*******************************draw plugin*************************************************** 
      
      mymap.addControl(new L.Control.Draw({position: 'topright'}));
      mymap.on(L.Draw.Event.CREATED, function (event) {
        var layer = event.layer;

        drawnItems.addLayer(layer);
    });

      
      
      drawnItems = L.featureGroup().addTo(mymap);
      layerControl.addOverlay(drawnItems,"Layer Edit");

      
      
      
// *******************************search plugin*****************************
    
controlSearch = L.Control.openCageSearch({key: 'b266f3972ebc451a88583014bb645f88',limit: 10}).addTo(mymap);
  // print plugin **************************************************************'
      var printer = L.easyPrint({
      		tileLayer: null,
      		sizeModes: ['Current', 'A4Landscape', 'A4Portrait'],
      		filename: 'myMap',
      		exportOnly: true,
      		hideControlContainer: true,
            position:'bottomright'
      }).addTo(mymap);
// measure plugin************************************************************************'
      L.control.polylineMeasure({position: 'topright'}).addTo(mymap);
     
      
     
 // Loading overlay layers from database********************************************************
 
      
 //..........Set working area tab..........
      

      //Seting a rectangle as working area
     $('#btn_area').on('click', function(){
      area='set_area';
      polygonDrawer.enable();
      (mymap).on('draw:created', function (e) {
                var type = e.layerType;
                    //alert(type);
                layer = e.layer;
          //geting the coordiates from the rectangle as string
               // if (type === 'rectangle') {
                    var coords = layer.getLatLngs().toString();
                    var str =coords;
           //removing unncecesary parts         
                    var res = str.replace(/LatLng/g,"");
                    var i = 0, length = res.length;
                        for (i; i < length; i++) {
                            res = res.replace("(","");
                            res = res.replace(")","");
                            res = res.replace(","," ");
                    }
            //removing comas, and duplicationg first element as the last one for postgis
                    var first_lat="";
                    var first_long="";
                    var first_lat_lng="";
                    var i = 0, length = res.length;
                        for (i; i <length; i++) {
                            res = res.replace("(","");
                            res = res.replace(")","");
                            res = res.replace(","," ");
                    }
                    //console.log(res);
                    
                    //first_lat=res.slice(0,  9);
                    first_lat_lng=res.match(/^(\d+\.\d+)\s\s(\d+\.\d+)/);
                    first_lat_lng=first_lat_lng[0].toString();
                    //first_lat_lng=first_lat_lng.replace("  "," ");
                    //console.log(first_lat_lng);

                    
            // adding comas and spaces:  lat long,lat long, lat long
            
                    res=res+" "+first_lat_lng;

                    res=res.replace(/\s/g,",");
                    res=res.replace(/\,\,/g," ");
                    coordString=res;
                    //alert(coordString);
  //}
      })
     })
      
     
  //Setting the full extent as working area
    $('#btn_fullextent').on('click', function(){
      area='full_extent';
      //alert(area);
  })
      
  //Setting the region mask as working area
     $('#btn_region').on('click', function(){
      area='region';
      alert(area);
  }) 

  //Setting the kommune mask as working area
    $('#btn_kommune').on('click', function(){
      area='kommune';
      alert(area);
  })    
       
   
  
      
  //**********Add layers from database tab*******Show overview of the layers available from database and see atribute table************    
      
 $("#seeLayers").click(function() {
  $.ajax({
    url: "load_db_view.php",
    success: function(response) {
      //********load_db_view creates a html table with the name of all the tables in the database and
      //2 buttons, view att table and add to working layers
        $("#tableData").html(response);
        $(".viewTableDb").click(function() {
        var tableName = $(this).attr("dataId");
        alert(tableName);
        //for each layer, attribute table is loaded into a modal box
        $.ajax({
          url: "load_attribute_table.php",
          data: { db_table: tableName },
          type: "POST",
          success: function(response) {
            $("#modalData").html(response);
            $("#dlgModal").show();
          }
        });
      });
     // bringing the layers to the map based on the work area selection
     // rectangle area selection
        if (area=='set_area'){
           $(".addTableDb").click(function(){
          var tableNameAdd=$(this).attr("id");
          $("#"+tableNameAdd).toggle();         //the button for ading the layer is hidden so the layer can not be added multiple times   
          $.ajax({
              url:"load_bbox.php",
              data:{db_table:tableNameAdd,bbox_coord:coordString},
              type:"POST",
              success: function(response){
                  var full_layer=JSON.parse(response);
                var layer= L.geoJSON(full_layer);
                  layer.addTo(mymap);
                  
              }
          })
      }) 
    // add data when the full extent tab is selected   
    }else if (area=='full_extent'){
          $(".addTableDb").click(function(){
          var tableNameAdd=$(this).attr("id");
              $("#"+tableNameAdd).toggle();         
          $.ajax({
              url:"load_full_extent.php",
              data:{db_table:tableNameAdd },
              type:"POST",
              success: function(response){
                  var full_layer=JSON.parse(response);
                var layer= L.geoJSON(full_layer);
                  layer.addTo(mymap);
                  layerControl.addOverlay(layer,tableNameAdd);
                  activeLayersList.push(tableNameAdd);
                  
                $(".active-container").append( "<br> <button>"+ tableNameAdd +"</button><br>" );
                

                 
                  
              }
          })
//          $.ajax({
//                      url:"create_check_box.php",
//                      data:{name:tableNameAdd},
//                      type:"POST",
//                      success:function(response){
//                          $("#activeLayersDiv").append(response);
//                      }
//                  })
      })
    //add data when the region tab is selected
    }else if (area=='region'){
        alert('region is coming')
    //add data when the kommune tab is selected
    }else if (area=='kommune'){
        alert('kommune is coming')
    // alert box for first setting an work area before adding data
    }else {
        alert('First set an Work Area!')  //do function**********************************************************************************************
    }
    
    }
  });
});

 $("#buttonCloseModal").click(function() {
  $("#dlgModal").hide();
});
     
//******************************Active Layers tab********************************************
 $("body").on( "click", ".active-container button", function(){
    var temp_layer;
     temp_layer=$(this).text();
        mymap.removeLayer(temp_layer); 
     
});    
      
      
   
            
            
      
      
      
      
      
      

      
      
  </script> 
   
   
    
</body>
</html>